#!/bin/bash
# run_once_after_50-setup-claude-mcp.sh.tmpl
# Runs once after chezmoi apply to set up Claude MCP servers
# Uses defaults if variables are missing

set -e

echo "ðŸ”§ Setting up Claude Code..."

# Skip if minimal install (defaults to false if missing)
{{ if .minimal | default false }}
echo "â­ï¸  Skipping Claude setup (minimal install)"
exit 0
{{ end }}

# Ensure directories exist
mkdir -p "$HOME/.claude/plugins"

{{ if .claude_mcp | default true }}
# Create .mcp.json if it doesn't exist or is empty
MCP_FILE="$HOME/.claude/.mcp.json"

if [ ! -s "$MCP_FILE" ]; then
    echo "ðŸ“¦ Creating MCP configuration..."
    # Handle read-only placeholder files
    [ -f "$MCP_FILE" ] && chmod 644 "$MCP_FILE"
    cat > "$MCP_FILE" << 'EOF'
{
  "context7": {
    "command": "npx",
    "args": ["-y", "@upstash/context7-mcp"]
  }
}
EOF
    echo "âœ… Created $MCP_FILE"
else
    echo "âœ… MCP config already exists"
fi
{{ else }}
echo "â­ï¸  Skipping MCP setup (claude_mcp = false)"
{{ end }}

echo "âœ… Claude setup complete"
