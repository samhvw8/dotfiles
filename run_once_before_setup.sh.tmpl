#!/bin/bash
{{- if eq .chezmoi.os "darwin" }}
# macOS setup script
{{- else }}
# Linux setup script  
{{- end }}

# This script runs once before chezmoi applies the dotfiles
# It ensures all necessary tools and dependencies are installed

set -euo pipefail

# Log functions
log_info() {
    echo -e "\033[0;34m[INFO]\033[0m $1"
}

log_error() {
    echo -e "\033[0;31m[ERROR]\033[0m $1" >&2
}

log_success() {
    echo -e "\033[0;32m[SUCCESS]\033[0m $1"
}

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Setup essential directories
setup_folders() {
    local dirs=(
        "$HOME/.local/bin"
        "$HOME/.local/share"
        "$HOME/.local/state"
        "$HOME/.local/run"
        "$HOME/.config"
        "$HOME/bin"
    )

    for dir in "${dirs[@]}"; do
        mkdir -p "$dir"
    done

    chmod 0700 "${HOME}/.local/run"
    log_success "Essential directories created"
}

# Install Homebrew on macOS
setup_homebrew() {
{{- if eq .chezmoi.os "darwin" }}
    if ! command_exists brew; then
        log_info "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
{{- end }}
}

# Install essential packages
setup_essential_packages() {
{{- if eq .chezmoi.os "linux" }}
    if command_exists apt; then
        sudo apt update
        sudo apt install -y git curl wget zsh
    fi
{{- end }}
}

# Setup fzf
setup_fzf() {
    if [[ ! -d "$HOME/.fzf" ]]; then
        log_info "Installing fzf..."
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        ~/.fzf/install --all
        log_success "fzf installed"
    fi
}

# Setup mise
setup_mise() {
    if ! command_exists mise; then
        log_info "Installing mise..."
        curl -fsSL https://mise.run | sh
        log_success "mise installed"
    fi
}

# Main execution
main() {
    log_info "Running chezmoi setup script..."
    
    setup_folders
    setup_homebrew
    setup_essential_packages
    setup_fzf
    setup_mise
    
    log_success "Chezmoi setup completed!"
}

main "$@"